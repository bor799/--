// ==UserScript==
// @name         å°å®‡å®™FMéŸ³é¢‘ä¸‹è½½å™¨
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  ä¸ºå°å®‡å®™FMæ·»åŠ MP3éŸ³é¢‘ä¸‹è½½åŠŸèƒ½ï¼Œæ”¯æŒè¿›åº¦æ˜¾ç¤ºå’Œæ ¼å¼éªŒè¯
// @author       Zane
// @match        https://www.xiaoyuzhoufm.com/episode/*
// @grant        GM_download
// @grant        GM_xmlhttpRequest
// @license      MIT
// ==/UserScript==

(function() {
    'use strict';

    // æ·»åŠ ä¸‹è½½æŒ‰é’®çš„æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .xiaoyuzhou-download-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        .xiaoyuzhou-download-btn:hover {
            background-color: #40a9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .xiaoyuzhou-download-btn.searching {
            background-color: #f0f0f0;
            color: #666;
            cursor: default;
        }
        .xiaoyuzhou-download-btn.error {
            background-color: #ff4d4f;
        }
        .xiaoyuzhou-download-btn i {
            font-size: 16px;
        }
        .xiaoyuzhou-download-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #1890ff;
            color: white;
            border-radius: 8px;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);

    // ä¸»å‡½æ•°
    function init() {
        console.log('åˆå§‹åŒ–å°å®‡å®™FMä¸‹è½½å™¨...');

        // é¿å…é‡å¤æ·»åŠ æŒ‰é’®
        const existingButton = document.querySelector('.xiaoyuzhou-download-btn');
        if (existingButton) {
            existingButton.remove();
        }

        // åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºæŒ‰é’®
        const statusButton = document.createElement('button');
        statusButton.className = 'xiaoyuzhou-download-btn searching';
        statusButton.innerHTML = `
            <i>ğŸ”</i>
            <span>æ­£åœ¨æŸ¥æ‰¾éŸ³é¢‘...</span>
        `;

        // æ’å…¥åˆ°æ ‡é¢˜ä¸‹æ–¹
        const title = document.querySelector('.jsx-399326063.title') ||
                     document.querySelector('.episode-title');
        if (title) {
            title.parentNode.insertBefore(statusButton, title.nextSibling);
        }

        let attempts = 0;
        const maxAttempts = 5;

        const checkInterval = setInterval(() => {
            attempts++;
            statusButton.innerHTML = `
                <i>ğŸ”</i>
                <span>æ­£åœ¨æŸ¥æ‰¾éŸ³é¢‘...${attempts}/${maxAttempts}</span>
            `;

            const audioElement = document.querySelector('audio');

            if (audioElement) {
                clearInterval(checkInterval);
                statusButton.innerHTML = `
                    <i>â¬‡ï¸</i>
                    <span>ä¸‹è½½MP3éŸ³é¢‘</span>
                `;
                statusButton.style.backgroundColor = '#1890ff';
                statusButton.style.color = 'white';
                statusButton.style.cursor = 'pointer';
                statusButton.classList.remove('searching');

                statusButton.addEventListener('click', () => {
                    if (audioElement.src) {
                        downloadAudio(audioElement.src);
                    } else {
                        const audioUrl = findAudioUrlFromPage();
                        if (audioUrl) {
                            downloadAudio(audioUrl);
                        } else {
                            showNotification('æœªèƒ½æ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶ï¼Œè¯·ç¡®ä¿éŸ³é¢‘å·²å¼€å§‹æ’­æ”¾', 'error');
                        }
                    }
                });
            }

            if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                statusButton.innerHTML = `
                    <i>âš ï¸</i>
                    <span>æœªæ‰¾åˆ°éŸ³é¢‘ï¼Œè¯·å…ˆæ’­æ”¾</span>
                `;
                statusButton.classList.add('error');
            }
        }, 1000);
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'xiaoyuzhou-download-status';
        notification.style.backgroundColor = type === 'error' ? '#ff4d4f' : '#1890ff';
        notification.innerHTML = `
            <i>${type === 'error' ? 'âš ï¸' : 'â„¹ï¸'}</i>
            <span>${message}</span>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
    }

    // ä»é¡µé¢æ•°æ®ä¸­æŸ¥æ‰¾éŸ³é¢‘URL
    function findAudioUrlFromPage() {
        const scripts = document.getElementsByTagName('script');
        for (const script of scripts) {
            const content = script.textContent;
            if (content && content.includes('audioUrl')) {
                const match = content.match(/"audioUrl":"([^"]+)"/);
                if (match && match[1]) {
                    return match[1];
                }
            }
        }
        return null;
    }

    // ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
    function downloadAudio(audioUrl) {
        if (!audioUrl) {
            showNotification('æœªæ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶', 'error');
            return;
        }

        // æ£€æŸ¥éŸ³é¢‘URLçš„æ ¼å¼
        if (!audioUrl.includes('.mp3')) {
            console.log('éŸ³é¢‘é“¾æ¥ä¸æ˜¯MP3æ ¼å¼:', audioUrl);
            showNotification('å½“å‰éŸ³é¢‘ä¸æ˜¯MP3æ ¼å¼ï¼Œæ— æ³•ä¸‹è½½', 'error');
            return;
        }

        // è·å–æ’­å®¢æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
        const title = document.querySelector('.episode-title')?.textContent ||
                     document.title ||
                     'å°å®‡å®™FMéŸ³é¢‘';
        const fileName = `${title}.mp3`.replace(/[\\/:*?"<>|]/g, '_');

        // æ˜¾ç¤ºä¸‹è½½çŠ¶æ€
        const downloadStatus = document.createElement('div');
        downloadStatus.className = 'xiaoyuzhou-download-status';
        downloadStatus.innerHTML = `
            <i>â¬</i>
            <span>æ­£åœ¨ä¸‹è½½MP3...0%</span>
        `;
        document.body.appendChild(downloadStatus);

        // ä½¿ç”¨GM_xmlhttpRequestä¸‹è½½æ–‡ä»¶
        GM_xmlhttpRequest({
            method: 'GET',
            url: audioUrl,
            responseType: 'blob',
            headers: {
                'Accept': 'audio/mpeg',
            },
            onprogress: (progress) => {
                if (progress.total) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    downloadStatus.innerHTML = `
                        <i>â¬</i>
                        <span>æ­£åœ¨ä¸‹è½½MP3...${percent}%</span>
                    `;
                }
            },
            onload: (response) => {
                const contentType = response.response.type;
                if (!contentType.includes('audio/mpeg') && !contentType.includes('audio/mp3')) {
                    showNotification('ä¸‹è½½å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ˜¯MP3', 'error');
                    document.body.removeChild(downloadStatus);
                    return;
                }

                const blob = new Blob([response.response], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    document.body.removeChild(downloadStatus);
                    showNotification('MP3ä¸‹è½½å®Œæˆï¼');
                }, 1000);

                console.log('MP3ä¸‹è½½å®Œæˆ');
            },
            onerror: (error) => {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showNotification('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                document.body.removeChild(downloadStatus);
            }
        });
    }

    // ç›‘å¬URLå˜åŒ–ï¼Œæ”¯æŒSPA
    let lastUrl = location.href;
    new MutationObserver(() => {
        const url = location.href;
        if (url !== lastUrl) {
            lastUrl = url;
            if (url.includes('xiaoyuzhoufm.com/episode/')) {
                init();
            }
        }
    }).observe(document, {subtree: true, childList: true});

    // åˆå§‹åŒ–
    init();
})();
